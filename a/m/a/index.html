<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WDBC Menu</title>
    <style>
      body {
        background-color: black;
        margin: 0;
        padding: 0;
      }
      #menu {
        margin: 0;
        padding: 0;
      }
      #menuframe {
        transition: all 0.5s fade-in fade-out;
      }
    </style>
  </head>
<body>
<div id="menu">WDBC FTW</div>
<script src="https://unpkg.com/hyperscript.org@0.9.9"></script>

<script>
  function check_for_reboot(boot_time, force=false) {
    // turned off 'till I can make the menu bar go away
    return false;
    // if (force == true) {
    //   window.location.reload(true);  // true is to ignore cache
    // }
    // // or, if it's in the right time window and we have been up
    // // for at least 70m
    // const seventy_minutes = 70 * 60 * 1000;  // in milliseconds
    // const the_hour = new Date().getHours();
    // if (
    //   // will look btw 1am and 2am
    //   (the_hour > 0 && the_hour < 2)
    //   && (Date.now() - boot_time > seventy_minutes)
    //   ) {
    //     window.location.reload(true);  // true is to ignore cache
    //   }
  }

  function what_proj_am_i() {
    let loc = window.location.toString();
    return loc.slice(-2, -1);
  }

  function time_for_updates() {
    const date = new Date();
    const hour = date.getHours();
    switch (date.getDay()) {
      // this is all one hour over in both directions
      case 0:  // Sunday
        // hours noon to 7p; are we close? then allow updates
        return hour >= 11 && hour < 8;
      case 5:  // Friday hours noon to 11p
        return hour >= 11 && hour < 24;
      case 6:  // Saturday noon to 11p
        return hour >= 11 && hour < 24;
      default:
        // Tues through Thurs open 3p close 10p
        return hour >= 14 && hour < 23;
    }
  }
</script>

<script type="text/hyperscript">
  init
    set $script_boot_time to Date.now()
    set $last_local_update to null
    set $last_slides_id to null

    repeat forever
      call check_for_update()
      -- log "Current id is ", $last_slides_id, " and update is ", $last_local_update
      -- there's a timeout setting in result.ck but I don't know how to make the expression
      -- for the wait command; it only seems to take its own literals, not variables or strings
      wait 180s
      log "."
    end
  end

  def slides_status()
    fetch https://script.google.com/macros/s/AKfycbwPLZ1ii2rhEj5nb931hCRh02s_KvLh_CIZhnEA3vXPK07o5Dukdk-NsRcCxDH2xOaw/exec as json
    then return the result as Object
  end

  -- do the actual updating of the iframe
  def do_update(status)
    call what_proj_am_i()
    if result == 'a'
      set pg to status.pa
    end
    if result == 'b'
      set pg to status.pb
    end
    if result == 'c'
      set pg to status.pc
    end
    if result == 'd'
      set pg to status.pd
    end
    log Date().toString(), "updating iframe on projector ", result, " to slide ", pg
    put `<iframe id="menuframe" src="https://docs.google.com/presentation/d/${status.id}/embed?start=false&loop=true&delayms=3000&rm=minimal&slide=${pg}" frameborder="0" width="1920" height="1080" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true" ></iframe>` into #menu
    set $last_local_update to Date.now()
    set $last_slides_id to status.id
  end

  -- determine whether we should update our iframe...
  def check_for_update()
    get the slides_status() then put it into status
    -- log status

    -- check to see if we should reboot
    call check_for_reboot($script_boot_time, status.force_reload)

    -- if this the first time, these will be null
    if $last_slides_id == null or $last_local_update == null
      log "first time... doing update"
      call do_update(status)
      return result
    end

    -- from now, only check if it's the right time of day
    if time_for_updates() == false
      log "Not updating because we are off hours"
      exit
    end

    if status.id != $last_slides_id
      -- log "IDs don't match..."
      call do_update(status)
      return result
    end

    if Date.parse(status.up) > $last_local_update
      -- log Date.parse(status.up), "is newer than", $last_local_update
      call do_update(status)
      return result
    end
    -- fall through; don't update:
    -- log "Not updating."
    return status
  end

</script>
</body>
</html>
